---
// SponsorCarousel.astro â€” auto-sliding sponsor banner carousel
// Reads from /sponsors.json at build time, shows active sponsors sorted by sortOrder
import sponsorData from '../../public/sponsors.json';

interface Sponsor {
  id: string;
  name: string;
  imageUrl: string;
  tapUrl: string;
  tagline?: string;
  active: boolean;
  sortOrder: number;
}

const sponsors: Sponsor[] = (sponsorData.sponsors as Sponsor[])
  .filter((s) => s.active)
  .sort((a, b) => a.sortOrder - b.sortOrder);
---

{sponsors.length > 0 && (
  <div class="sponsor-carousel-wrapper animate-on-scroll" data-sponsor-carousel>
    <div class="sponsor-carousel-header">
      <span class="sponsor-label">Our Sponsors</span>
    </div>
    <div class="sponsor-carousel" aria-label="Sponsors">
      <div class="sponsor-track">
        {sponsors.map((sponsor) => (
          <a
            href={sponsor.tapUrl}
            target="_blank"
            rel="noopener noreferrer sponsored"
            class="sponsor-slide"
            title={sponsor.tagline || sponsor.name}
          >
            <img
              src={sponsor.imageUrl}
              alt={sponsor.name}
              class="sponsor-img"
              loading="eager"
              width="400"
              height="150"
            />
          </a>
        ))}
      </div>
    </div>
    <div class="sponsor-dots">
      {sponsors.map((_, i) => (
        <button
          class={`sponsor-dot ${i === 0 ? 'active' : ''}`}
          data-index={i}
          aria-label={`Go to sponsor ${i + 1}`}
        />
      ))}
    </div>
  </div>
)}

<style>
  .sponsor-carousel-wrapper {
    width: 100%;
    padding: 1.5rem 0;
    position: relative;
  }

  .sponsor-carousel-header {
    text-align: center;
    margin-bottom: 1rem;
  }

  .sponsor-label {
    font-family: var(--font-display);
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: var(--color-gold-500);
  }

  .sponsor-carousel {
    width: 100%;
    overflow: hidden;
    position: relative;
    border-radius: 0.75rem;
  }

  .sponsor-track {
    display: flex;
    will-change: transform;
  }

  .sponsor-slide {
    flex: 0 0 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1rem;
    min-height: 100px;
  }

  @media (min-width: 768px) {
    .sponsor-slide {
      min-height: 120px;
    }
  }

  .sponsor-img {
    max-width: 100%;
    max-height: 120px;
    width: auto;
    height: auto;
    object-fit: contain;
    border-radius: 0.5rem;
    transition: transform 0.3s ease;
  }

  .sponsor-slide:hover .sponsor-img {
    transform: scale(1.03);
  }

  @media (min-width: 768px) {
    .sponsor-img {
      max-height: 140px;
    }
  }

  .sponsor-dots {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 0.75rem;
  }

  .sponsor-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: none;
    background: var(--color-navy-200);
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
  }

  .sponsor-dot.active {
    background: var(--color-gold-500);
    transform: scale(1.3);
  }

  .sponsor-dot:hover {
    background: var(--color-gold-400);
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Initialize EACH carousel instance independently
    const carousels = document.querySelectorAll('[data-sponsor-carousel]');

    carousels.forEach((wrapper) => {
      const track = wrapper.querySelector('.sponsor-track') as HTMLElement;
      const carousel = wrapper.querySelector('.sponsor-carousel') as HTMLElement;
      const dots = wrapper.querySelectorAll('.sponsor-dot');
      if (!track || !carousel || dots.length === 0) return;

      const totalSponsors = dots.length;
      let currentIndex = 0;
      let autoPlayTimer: ReturnType<typeof setInterval>;
      let isHovered = false;

      function getSlideWidth(): number {
        return carousel.offsetWidth;
      }

      function goToSlide(index: number, animate = true) {
        currentIndex = index;
        const offset = -(currentIndex * getSlideWidth());

        if (animate) {
          track.style.transition = 'transform 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
        } else {
          track.style.transition = 'none';
        }

        track.style.transform = `translateX(${offset}px)`;

        dots.forEach((dot, i) => {
          dot.classList.toggle('active', i === currentIndex);
        });
      }

      function nextSlide() {
        const next = (currentIndex + 1) % totalSponsors;
        goToSlide(next, true);
      }

      function prevSlide() {
        const prev = (currentIndex - 1 + totalSponsors) % totalSponsors;
        goToSlide(prev, true);
      }

      function startAutoPlay() {
        stopAutoPlay();
        autoPlayTimer = setInterval(() => {
          if (!isHovered) nextSlide();
        }, 4000);
      }

      function stopAutoPlay() {
        if (autoPlayTimer) clearInterval(autoPlayTimer);
      }

      // Dot click navigation
      dots.forEach((dot, i) => {
        dot.addEventListener('click', () => {
          goToSlide(i, true);
          startAutoPlay();
        });
      });

      // Pause on hover
      wrapper.addEventListener('mouseenter', () => { isHovered = true; });
      wrapper.addEventListener('mouseleave', () => { isHovered = false; });

      // Touch swipe support
      let touchStartX = 0;
      track.addEventListener('touchstart', (e: TouchEvent) => {
        touchStartX = e.changedTouches[0].screenX;
      }, { passive: true });
      track.addEventListener('touchend', (e: TouchEvent) => {
        const touchEndX = e.changedTouches[0].screenX;
        const diff = touchStartX - touchEndX;
        if (Math.abs(diff) > 50) {
          diff > 0 ? nextSlide() : prevSlide();
          startAutoPlay();
        }
      }, { passive: true });

      // Recalculate on resize
      let resizeTimer: ReturnType<typeof setTimeout>;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => goToSlide(currentIndex, false), 100);
      });

      // Start
      startAutoPlay();
    });
  });
</script>
